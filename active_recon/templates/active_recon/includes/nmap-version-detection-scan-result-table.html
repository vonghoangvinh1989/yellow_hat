{% include 'report/includes/report-name.html' %}

<script>
    function createNmapVersionDetectionResult(data) {
        let table;

        table = new Tabulator("#scanning-result", {
            downloadEncoder:function(fileContents, mimeType){
                var blob = new Blob([fileContents], { type: mimeType });

                // Send the Blob to the server
                savePdfToServer(blob);

                return new Blob([fileContents], {type:mimeType});
            },
            height: 400, // Set height of table
            data: data, // Assign port data to Tabulator
            layout: "fitColumns", // Fit columns to width of table
            theme: "bootstrap4",
            columns: [
                    { title: "Port ID", field: "portid", width: 100 },
                    { title: "Protocol", field: "protocol", width: 100 },
                    { title: "State", field: "state", width: 100 },
                    { title: "Reason", field: "reason", width: 150 },
                    { title: "Service Name", field: "service.name", width: 150 },
                    { title: "Service Product", field: "service.product", width: 150 },
                    { title: "Service Version", field: "service.version", width: 150 },
                    { title: "Service Extra Info", field: "service.extrainfo", width: 200 },
                    { title: "Service OS Type", field: "service.ostype", width: 150 },
                    {
                        title: "CPE",
                        field: "cpe",
                        formatter: function(cell, formatterParams, onRendered) {
                            const cpeArray = cell.getValue();
                            return cpeArray && cpeArray.length > 0 ? cpeArray.map(cpe => cpe.cpe).join(", ") : "N/A";
                        },
                        width: 300,
                    },
                ],
            responsiveLayout: "hide", // Hide columns that don't fit on the table
            addRowPos: "top", // When adding a new row, add it to the top of the table
            history: true, // Allow undo and redo actions on the table
            movableColumns: true, // Allow column order to be changed
            columnDefaults: {
                tooltip: true, // Show tooltips on cells
            },
        });

        return table;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Function to save the PDF Blob to the server
    function savePdfToServer(pdfBlob) {
        // get the passive tool name from backend
        let activeToolName = "{{ active_tool.name }}";

        // generate report pdf file name
        let pdfReportFileName = generateReportName(activeToolName)

        // generate pop-up
        let successPopUp = new Popup({
            id: `${pdfReportFileName}`,
            title: "Report Saved Successfully",
            content: `A file with name <strong>${pdfReportFileName}.pdf</strong> was generated successfully.`,
        });

        let formData = new FormData();
        formData.append('pdf', pdfBlob, `${pdfReportFileName}.pdf`); // Append the Blob to FormData
        formData.append('file_type', 'pdf'); // Append additional field file_type
        formData.append('table_from', 'tabulator'); // Append additional field table_from

        $.ajax({
            type: 'POST',
            url: "{% url 'save-report' %}",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': getCookie('csrftoken') // Include CSRF token for security
            },
            success: function(response, textStatus, jqXHR) {
                if (jqXHR.status === 200) {
                    successPopUp.show(); // Show success popup
                } else {
                    alert('Error saving PDF file');
                }
            },
            error: function(error) {
                console.log('Error during saving report: ', error);
                alert('An error occurred while saving the report. Please try again.');
            }
        });
    }
</script>