{% extends 'main_app/base/base.html' %}

{% load static %}

{% block title %}Paramiko SSH Brute Force{% endblock %}

{% block site_css %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/css/bootstrap/tabulator_bootstrap4.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'active_recon/styles/active_recon.css' %}">
    <style>
       .vertical-separator {
            border-left: 2px solid #ccc;
            height: 100vh;
            margin-left: -1px;
            margin-top: 40px;
        }

        #output-section-container, #create-account-section-container {
            display: flex;
            align-items: top;
            height: 100vh;
            margin-top: 40px;
        }

        .output-blockquote {
            max-height: 800px; /* Adjust this value as needed */
            overflow-y: auto;
        }
    </style>
{% endblock %}

{% block main_heading %}
    Paramiko SSH
{% endblock %}

{% block body %}
    <section>
        <div class="container">
            <form id="brute-force-form" name="brute-force-form" method="POST" enctype="multipart/form-data" class="row align-items-bottom">
                {% csrf_token %}
                <div class="col-auto">
                    <label for="target_ip">Target IP</label>
                    <input type="text" class="form-control" name="target_ip" id="target_ip" placeholder="IP - ex:192.168.56.105" required>
                </div>
                <div class="col-auto">
                    <label for="username_list" class="visually-hidden">Username List</label>
                    <small class="form-text text-muted">Upload a file containing a list of usernames</small>
                    <input type="file" class="form-control" name="username_list" id="username_list" required>
                </div>
                <div class="col-auto">
                    <small class="form-text text-muted">Upload a file containing a list of passwords</small>
                    <label for="password_list" class="visually-hidden">Password List</label>
                    <input type="file" class="form-control" name="password_list" id="password_list" required>
                </div>
                <div class="form-group col-auto d-flex align-items-end">
                    <button id="attack-button" type="submit" class="btn btn-primary">Attack</button>
                </div>
            </form>
        </div>
    </section>

    <section class="hidden progress-section" id="progress-section">
        <div class="container">
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                    <span class="progress-bar-text">It could take minutes to process. Please be patient...</span>
                </div>
            </div>
        </div>
    </section>

    <div class="container-fluid">
        <div class="row">
            <!-- Output Section -->
            <div class="col-md-8" id="output-section-container">
                <section class="hidden" id="output-section">
                    <div class="container">
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <h2 class="mb-0">Output Result</h2>
                            </div>
                        </div>
                        <blockquote class="blockquote p-3 border border-primary rounded output-blockquote">
                            <div id="brute-force-result"></div>
                        </blockquote>
                    </div>
                </section>
            </div>
    
            <!-- Vertical Line Separator -->
            <div class="col-md-1 vertical-separator"></div>
    
            <!-- Create Account Section -->
            <div class="col-md-3" id="create-account-section-container">
                <section id="create-account-section">
                    <div class="container">
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <h2 class="mb-0">Test Creating Account</h2>
                            </div>
                        </div>
                        <form id="create-account-form">
                            <div class="form-group">
                                <label for="victim-ip">Victim Machine IP</label>
                                <input type="text" class="form-control" name="victim-ip" id="victim-ip" placeholder="IP" required>
                            </div>
                            <div class="form-group">
                                <label for="victim-username">Victim Machine Username</label>
                                <input type="text" class="form-control" name="victim-username" id="victim-username" placeholder="username" required>
                            </div>
                            <div class="form-group">
                                <label for="victim-password">Victim Machine Password</label>
                                <input type="password" class="form-control" name="victim-password" id="victim-password" placeholder="password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-username">New Username</label>
                                <input type="text" class="form-control" name="new-username" id="new-username" placeholder="Enter new username" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" class="form-control" name="new-password" id="new-password" placeholder="Enter new password" required>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">Create Account</button>
                        </form>
                        <!-- Progress Section -->
                        <div id="progress-section-2" class="mt-3 hidden">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Creating account...</span>
                            </div>
                            <p>Creating account, please wait...</p>
                        </div>
                        <div id="account-creation-result" class="mt-3"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block script_js %}
    <script src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            $('#brute-force-form').on('submit', function(event) {
                event.preventDefault();

                let outputSection = $('#output-section');
                let bruteForceResult = $('#brute-force-result');

                outputSection.hide();

                let attackButton = $('#attack-button');
                attackButton.prop('disabled', true);

                let progressSection = $('#progress-section');
                progressSection.show();

                let formData = new FormData(this); // Capture the form data, including files

                $.ajax({
                    type: 'POST',
                    url: "{% url 'exploitation-tools' exploitation_tool.slug %}",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        if (response.error_message) {
                            bruteForceResult.text(response.error_message);
                            progressSection.hide();
                            outputSection.show();
                            attackButton.prop('disabled', false);
                        } else {
                            // Now initiate the EventSource connection to get real-time feedback
                            let targetIp = formData.get('target_ip');

                            // The username_list and password_list are already saved server-side, 
                            // so we don't need to send them again via EventSource.
                            let eventSource = new EventSource("{% url 'paramiko-ssh-brute-force-stream' exploitation_tool.slug %}?target_ip=" + encodeURIComponent(targetIp));

                            eventSource.onmessage = function(event) {
                                let data = event.data;
                                bruteForceResult.append(data + "<br>");
                            };

                            eventSource.onerror = function(error) {
                                bruteForceResult.append('An error occurred during the attack. Please try again.<br>');
                                console.error('Error during attack: ', error);
                                progressSection.hide();
                                outputSection.show();
                                attackButton.prop('disabled', false);
                                eventSource.close();
                            };

                            eventSource.onclose = function() {
                                progressSection.hide();
                                outputSection.show();
                                attackButton.prop('disabled', false);
                            };
                        }
                    },
                    error: function(error) {
                        bruteForceResult.text('An error occurred during the attack. Please try again.');
                        console.log('Error during attack: ', error);
                        progressSection.hide();
                        outputSection.show();
                        attackButton.prop('disabled', false);
                    }
                });
            }); // end form 


            $('#create-account-form').on('submit', function(event) {
                event.preventDefault();

                let createAccountResult = $('#account-creation-result');
                let createAccountBtn = $('#create-account-btn'); // Button for creating account
                let progressSection = $('#progress-section-2'); // Progress section to show while waiting

                let formData = new FormData(this); // Capture the form data, including files

                // Hide the create account button and show progress section
                createAccountBtn.prop('disabled', true);  // Disable the button to prevent multiple submissions
                progressSection.removeClass('hidden'); // Show progress section

                $.ajax({
                    type: 'POST',
                    url: "{% url 'paramiko-test-create-account' %}", // Replace with your actual URL for creating account
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        if (response.success) {
                            createAccountResult.html('<div class="alert alert-success">Account created successfully!</div>');
                        } else {
                            createAccountResult.html(`<div class="alert alert-danger">Failed to create account: ${response.error}</div>`);
                        }
                    },
                    error: function(error) {
                        createAccountResult.html('<div class="alert alert-danger">An error occurred while creating the account. Please try again.</div>');
                        console.log('Error during account creation: ', error);
                    },
                    complete: function() {
                        // After the request is complete, hide the progress section and enable the button again
                        progressSection.addClass('hidden'); // Hide progress section
                        createAccountBtn.prop('disabled', false); // Re-enable the button
                    }
                });
            }); // end form
        });
    </script>
{% endblock %}
