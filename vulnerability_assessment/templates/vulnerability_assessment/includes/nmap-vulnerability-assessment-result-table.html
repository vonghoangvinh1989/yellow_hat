{% include 'vulnerability_assessment/includes/save-report-table.html' %}
<script>
    function initializeTable(records) {
            const nmaptable = new Tabulator("#vulnerability-table", {
                downloadEncoder:function(fileContents, mimeType) {
                    let blob = new Blob([fileContents], { type: mimeType });

                    // Check if the save report button was clicked
                    if (isSaveReportButtonClicked) {
                        // Send the Blob to the server
                        savePdfToServer(blob);
                        return false;
                    }
                    return new Blob([fileContents], {type:mimeType});
                },
                data: records, // Set data
                layout: "fitColumns", // Fit columns to width of table
                theme: "bootstrap4",
                columns: [
                    {title: "Host", field: "host", width: 200, headerFilter: "input", headerFilterPlaceholder: "search host"},
                    {title: "Protocol", field: "protocol", width: 100, headerFilter: "input", headerFilterPlaceholder: "search protocol"},
                    {title: "Port", field: "port", width: 100, headerFilter: "input", headerFilterPlaceholder: "search port"},
                    {title: "State", field: "state", width: 100, headerFilter: "input", headerFilterPlaceholder: "search state"},
                    {title: "CPE", field: "cpe", headerFilter: "input", headerFilterPlaceholder: "search cpe"},
                    {title: "CVE Score", field: "score", width: 150, headerFilter: "input", headerFilterPlaceholder: "search score"},
                    {title: "URL", field: "url", formatter: "link", formatterParams: {target: "_blank"}},
                    {title: "Is Exploit", field: "is_exploit", formatter: "tickCross", headerFilter: "input", headerFilterPlaceholder: "search is_exploit"}
                ],
                pagination: "local", // Enable local pagination
                paginationSize: 10, // Number of rows per page
                movableColumns: true, // Allow dragging columns
                resizableRows: true, // Allow row resizing
                responsiveLayout: "hide", // Hide columns that don't fit on the table
                addRowPos: "top", // When adding a new row, add it to the top of the table
                history: true, // Allow undo and redo actions on the table
                columnDefaults: {
                    tooltip: true, // Show tooltips on cells
                },
            });

            return nmaptable;
        }

    function transformData(jsonData) {
        const data = jsonData;
        const result = [];

        data.forEach(item => {
            const host = item.host;

            item.protocols.forEach(protocol => {
                const protocolName = protocol.protocol;

                protocol.ports.forEach(port => {
                    const portNumber = port.port;
                    const portState = port.state;

                    // Handle case where scripts might be missing
                    const vulners = port.scripts?.vulners || "";
                    const lines = vulners.split('\n');

                    lines.forEach(line => {
                        const parts = line.trim().split('\t');
                        if (parts.length >= 4) {
                            const cpe = parts[0].trim();
                            const score = parts[1].trim();
                            const url = parts[2].trim();
                            const exploitId = parts[3].trim();
                            const isExploit = exploitId.includes("*EXPLOIT*");

                            result.push({
                                host: host,
                                protocol: protocolName,
                                port: portNumber,
                                state: portState,
                                cpe: cpe,
                                score: score,
                                url: url,
                                exploit_id: exploitId,
                                is_exploit: isExploit
                            });
                        }
                    });
                });
            });
        });

        return result;
    }
</script>